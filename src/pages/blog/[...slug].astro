---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createClient } from "@supabase/supabase-js";
import { marked } from "marked";

export async function getStaticPaths() {
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  const { data: posts } = await supabase
    .from("blog_posts")
    .select("slug")
    .eq("published", true);

  return posts?.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  })) ?? [];
}

const supabase = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY
);

type Props = {
  slug: string;
};

const { slug } = Astro.params;

const { data: post } = await supabase
  .from("blog_posts")
  .select("title,excerpt,content,created_at")
  .eq("slug", slug)
  .eq("published", true)
  .maybeSingle();

if (!post) return Astro.redirect("/blog");

const html = marked.parse(post.content);
---

<BaseLayout title={`${post.title} â€” bvislaoch`} description={post.excerpt ?? ""}>
  <section class="mx-auto max-w-3xl px-4 py-16">
    <h1 class="text-4xl font-semibold tracking-tight">{post.title}</h1>
    <p class="mt-3 text-sm opacity-70">{post.created_at?.slice(0,10)}</p>

    <article class="prose mt-10 dark:prose-invert max-w-none" set:html={html}></article>
  </section>
</BaseLayout>